# 대장간 V3.4 - 재단 최적화 알고리즘 (logic_ver4.md)
**목표:** SketchCut과 유사한 결과(큰 것 우선 + 끼워넣기, 단일 규격은 그리드형 수렴)를 내면서,  
**현장 제약: 2440 방향 가로 절단은 항상 전폭(1220) 관통**을 100% 만족하는 **단일 모드** 알고리즘.

> V3.3(lookahead/렉시코/국소 retry) +  
> **(A) TDD(고정 테스트 케이스), (B) Visual Debugger(선택 근거 수치화), (C) Fallback(안전장치)** 를 포함한 운영 가능한 개발 문서입니다.

---

## 1. 단일 모드 개요: Full-Pass Level(Band) + Space-first Placement

### 1.1 현장 하드 제약(필수)
- 작업자는 **2440 방향 가로 절단을 중간에 멈추지 않고 완전 관통**한다.
- 따라서 알고리즘은 **가로 절단선이 판재 폭(1220)을 항상 끝까지 관통**하도록만 계획해야 한다.
- **부분 가로 절단(Partial Crosscut)** 형태가 되는 배치는 금지한다.
- 구현 관점: **Band 경계에서만** 가로 절단선이 생성되어야 한다.

### 1.2 배치 구조(결과 형태)
- 판재를 위에서 아래로 **가로띠(Level/Band)** 로 쌓는다.
- 각 Band 내부는 **세로(Rip) 분할**로만 채운다(빈 폭 구간 span 기반).
- Band 경계가 곧 **“관통 가로 절단선”** 이 된다.

---

## 2. 전체 처리 흐름(한 장 기준)
1) **현재 판재 상단부터** Band 생성(높이 H 선택)  
2) Band 내부에 부품 배치(세로 분할 중심)  
3) 더 못 넣으면 다음 Band로 하강  
4) Band 생성 불가 또는 공간 부족 시 새 판재로 이동  
5) 모든 부품 배치 완료 시 종료

---

## 3. Band 생성(핵심): Top-K + 1-Step Lookahead (Risk 1 대응)

### 3.1 후보 Band 높이(H) 생성
- 후보 H = 남은 부품들의 높이(세로치수) 상위 K개 (권장 K=5)
- 회전 허용(`rotatable=true`)이면, 회전된 높이도 후보에 포함
  - 단, Grain(나무결) 고정이면 회전 후보 제외

### 3.2 Band 높이 선택: “현재 + 다음” 1-step lookahead
- `Total(H) = ScoreBandLex(H | S0) + λ * BestNextApprox(S1)`  
  - S1 = PlaceBand(H) 후 상태
  - BestNextApprox = 다음 Band 후보들에 대한 **간이 평가(저비용)**
- 권장 λ = 0.3 ~ 0.6 (초기 0.4)

> BestNextApprox는 “완전 재배치”가 아니라, 다음 후보 H2에 대해  
> **하드제약 위반 여부 + 대략적 활용률/슬리버 위험**만 산출해도 충분합니다.

---

## 4. 점수/튜닝 전략: 하드 제약 + 렉시코 우선순위 (Risk 2 대응)

### 4.1 하드 제약(위반 시 후보 즉시 폐기)
- **C1. 슬리버 금지:** 남는 폭/높이가 `min_part_dim + kerf` 미만으로 생성되는 후보는 폐기
- **C2. 관통절단 규칙 위반 금지:** Band 경계 외 가로선이 발생하도록 유도하는 배치 금지
- **C3. 회전/Grain 정책 위반 금지**
- **C4. Kerf 반영 누락 금지**

### 4.2 렉시코 우선순위(가중치 대신 “순서”)
**Band 선택 우선순위(ScoreBandLex):**
1) 슬리버 발생 개수/위험 최소
2) 잔여 span(폭 구간) 개수 증가 최소
3) Band 활용률(채움률) 최대
4) 정수 분할 보너스(동률일 때만)

**Band 내부 배치 우선순위(ScorePlaceLex):**
1) 슬리버 생성 금지/최소
2) 남는 폭 최소(단, 슬리버 되면 탈락)
3) span 조각 수 증가 최소
4) 큰 부품 우선(면적/긴변 우선) — 동률일 때 가점

### 4.3 정수 분할 보너스의 위치
- 정수분할 보너스는 **동률일 때만** 사용
- “억지 줄맞춤” 유발 방지

---

## 5. Band 내부 배치(끼워넣기 재현)

### 5.1 부품 선택(큰 것 우선)
- 기본: 면적 내림차순
- 동률: 긴 변/적합도 우선

### 5.2 span 기반 배치
- 시작 span: [0, 1220]
- 배치 시:
  - `neededWidth = first ? w : w + kerf`
  - 들어갈 수 있는 span 후보 탐색
  - `ScorePlaceLex`로 최적 후보 선택
- 배치 후 span 업데이트

---

## 6. Tail 문제 대응: 마지막 1~2 Band 국소 Retry (Risk 3 대응)

### 6.1 Tail 트리거(재시도 조건)
- 마지막 Band 활용률 < T (권장 T=0.55)
- 슬리버 위험 발생
- 남은 부품 높이 분포가 특정 값에 과도하게 몰림(예: 300mm 다량)

### 6.2 국소 Retry 범위(제한)
- 직전 1개 Band, 최대 2개 Band까지만 되돌림
- 재시도 횟수 상한: 3회

### 6.3 Retry 전략(가벼운 순서)
1) Band 높이 대체(2~3위 후보로 교체)
2) 상위 1~3개 부품 스왑/회수
3) 실패 시 새 판재로 넘김(현장 안정성 우선)

---

## 7. 운영 보완 지침(필수): TDD / Visual Debugger / Fallback

### 7.1 TDD (Test-Driven Development) — **필수**
#### 7.1.1 고정 Unit Test 케이스(최소 2개)
- **TC1: sketch1(격자)**  
  - 판재: 2440×1220  
  - 부품: 400×300, 35개 (회전 정책은 실제와 동일)
- **TC2: sketch2(혼합)**  
  - 판재: 2440×1220  
  - 부품: 1000×800 9개, 910×650 9개, 530×450 9개 (회전 정책은 실제와 동일)

#### 7.1.2 합격 기준(권장)
- **HARD:** 관통절단 위반 0, 슬리버 0, kerf 반영 누락 0
- **EFF:** 수율(면적 기준) ≥ 기준값(예: 스케치컷 결과 대비 -X% 이내)
- **PATTERN:** 큰 부품 우선 배치 경향 및 잔여 span 품질 유지(정성+정량 혼합)

> 가중치(W) 튜닝이 아니라, **규칙/우선순위/제약이 깨지지 않는지**를 먼저 테스트로 고정합니다.

---

### 7.2 Visual Debugger — **필수**
튜닝/운영을 위해 “왜 A가 아니라 B를 선택했는지”를 **숫자로 설명**해야 합니다.

#### 7.2.1 최소 로그 스펙(텍스트 로그로 시작)
- Band 선택 시:
  - 후보 H Top-K 목록
  - 각 후보의 렉시코 비교 결과(슬리버/스팬/활용률/동률보너스)
  - lookahead BestNextApprox 및 최종 Total(H)
  - 최종 선택 사유(우선순위 근거)
- Band 내부 배치 시:
  - 부품 선택 순서(상위 N개)
  - span 후보와 선택된 span, 탈락 사유(슬리버/규칙 위반)
- Tail Retry 시:
  - 트리거 사유(활용률/슬리버/분포)
  - 바꾼 H 후보/스왑 결과 비교

#### 7.2.2 시각화(선택)
- 콘솔 로그 → JSON trace 저장 → UI에서 후보 점수 테이블로 렌더링
- 목표: “의사결정 Trace”가 남아야 재현/튜닝 가능

---

### 7.3 Fallback Logic(안전장치) — **필수, 단계형**
“수율이 낮다”는 이유로 즉시 다른 알고리즘(가로우선)으로 롤백하면 목표 패턴이 깨질 수 있으므로,  
**단일 모드 내부에서 보수적 재시도 → 최후에만 타 로직** 순서로 설계합니다.

#### 7.3.1 수율 측정 기준(권장)
- `Yield = (배치된 부품 면적 합) / (사용한 판재 면적 합)`
- 가능하면 **스케치컷 결과 대비 상대값**도 함께 기록(Regression에 유리)

#### 7.3.2 단계형 Fallback 절차
- **Step 1:** Tail Retry(범위/횟수 내) 우선 실행
- **Step 2:** 파라미터 스윕 1~2회(예: λ 조정, K 조정)
- **Step 3:** “보수적 단일 모드” 재실행  
  - 예: 슬리버 기준 강화, Band 후보를 큰 높이 위주로 제한
- **Step 4 (최후):** 그래도 `Yield < 0.60` 이면 **단순 가로우선**으로 롤백(운영 안전성 목적)

> 주의: 0.60 기준은 환경/데이터에 따라 조정 가능하며, “최후 단계”에서만 사용합니다.

---

## 8. 공통 규칙(기존 유지)
- Rotation: `rotatable=true`만 후보, Grain 고정 시 비활성화
- Kerf: 모든 폭/높이 계산에 반영(`neededWidth = first ? w : w + kerf`)
- LabelingEngine: 동일 규격 동일 라벨, 첫 1개만 상세 치수 표기

---

## 9. 삭제/금지 항목
- **2장 묶음 스트립(폭×2) 로직 없음**
- **부분 가로 절단 금지**(Band 경계 외 가로선 유도 금지)

---

## 10. 권장 파라미터(초기값)
- Top-K: 5
- λ(lookahead): 0.4
- Tail 트리거 활용률 T: 0.55
- Retry 최대 횟수: 3
- 슬리버 기준: `min_part_dim + kerf`

---

*Last Updated: 2026-02-04 (logic_ver4.md)*
