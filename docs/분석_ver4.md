# 대장간 V4 - 알고리즘 변경 분석 Ver.4

> 작성일: 2026-02-04  \
> 버전: 4.0 (2단계 리핑-재적용 + 상위 폭 그룹 우선 + PDF/재단비 대응)  \
> 작성자: Codex

---

## 1. 문서 목적

이번 작업에서 **실제 코드에 반영된 알고리즘 변경 사항**을 정리하고,  
현장 절단 흐름(큰 사이즈 먼저 → 잔여 활용)과의 정합성을 평가한다.

---

## 2. 적용 완료된 변경 요약

### 2.1 자동 모드: 2단계 리핑-재적용
- `auto` 모드는 이제 **리핑-재적용 전략(`rip-reapply`)**을 사용한다.
- 흐름:
  1) 전체 판재에 1차 리핑 배치
  2) 남은 직사각형 잔여(`freeRects`) 추출
  3) 잔여를 “새 판재”처럼 간주하고 재배치
  4) 추가 배치가 없으면 종료

### 2.2 가로우선 모드 변경
- `horizontal`은 이제 **동일 폭 스트립**만 배치한다.
- 목표: “폭 동일 스트립 내 배치”만 허용하여 절단 편의성 유지

### 2.3 1차 배치 제한 (A안)
- 1차 배치에서는 **폭/높이 그룹 상위 2개만** 사용
- 작은 폭 그룹은 **2차 잔여 배치에서만** 사용 가능
- 목적: **B 하부 잔여(큰 짜투리2)**를 먼저 활용하도록 유도

### 2.4 splice 버그 수정
- `StripBin`, `StripEfficiencyBin`에서 잘못된 `splice` 순서 수정
- 아이템 복제 및 판재 폭증 문제 해결

---

## 3. 리핑-재적용 로직 상세

### 3.1 기본 흐름
```
Root Rect
→ 1차 리핑 배치 (상위 폭/높이 그룹)
→ 잔여 직사각형 추출
→ 잔여 재적용 (모든 그룹 허용)
→ 더 이상 배치 없으면 종료
```

### 3.2 리핑 축 선택
- 현재 구현: `rect.width <= rect.height`일 때 폭 스트립
- 즉, **직사각형의 짧은 축이 가로일 때만** 폭 스트립을 사용
- 이 조건이 **현장 의도(1220 방향으로 리핑)**와 충돌할 수 있음

---

## 4. 현장 패턴2 기준 적용 여부

### 4.1 현장 절단 시나리오
1) 910×650 두 개를 **세로(1220 방향)**로 먼저 절단
2) 해당 영역을 **가로 절단**하여 아래 잔여(짜투리2) 확보
3) 큰 잔여(짜투리2)에 C(530×450) 배치

### 4.2 코드 적용 상태
- **2차 잔여 활용 구조는 적용됨** ✅
- 그러나 **리핑 축 선택 조건이 반대**로 작동할 경우:
  - 1000×800이 먼저 배치되고
  - 하부 잔여가 415.8mm로 축소됨
  - C(450mm)가 배치 불가 ❌

### 4.3 결론
- **논리 구조는 적용되었으나**, 리핑 축 선택 조건이 잘못되면
  현장 패턴2의 의도대로 **C가 들어가지 못함**

---

## 5. PDF/재단비 관련 개선

### 5.1 PDF 잔여 표시 기준 완화
- 잔여 표시 기준을 `160mm` → `50mm`로 변경
- 배치 가능 여부와 무관하게 잔여 표시

### 5.2 재단비 미출력 대응
- `materialUsageRate` 없는 DOM 접근 방어
- 배치 실패 시에도 결과/재단비 출력되도록 흐름 수정
- `index.html`에 `materialUsageRate` 표시 영역 추가

---

## 6. 남은 리스크

1) **리핑 축 선택 조건의 정합성 문제**
   - 현장 의도(1220 방향 리핑)와 불일치 가능
   - 수정 필요 (조건 반전 또는 고정)

2) **폭 그룹 상위 2개 제한의 부작용**
   - 특정 케이스에서 작은 폭 부품이 과도하게 지연될 수 있음
   - 조건을 “상위 N개” 또는 “폭 임계치 기준”으로 조정 필요

3) **결과 패턴 다양성 증가**
   - 잔여 재배치로 인해 패턴 수 증가 가능

---

## 7. 향후 수정 제안

### 7.1 리핑 축 선택 확정
- 목표: **항상 짧은 축 방향(예: 1220)을 리핑 축으로 사용**
- 필요 시 옵션화

### 7.2 1차 배치 제한 개선
- 상위 2개 폭 고정 대신 **폭 임계치 기반** 추천
  - 예: `width >= 700`은 1차, 그 외는 2차

### 7.3 패턴2 재현 테스트 고정
- 케이스: 1000×800×9, 910×650×9, 530×450×9
- 성공 조건: **B 하부 잔여에 C 최소 1개** 배치 확인

---

## 8. 변경 파일 목록

- `js/packer.js`
  - `pack()` auto → rip-reapply
  - `WidthStripBin` 추가
  - `RipReapplyBin` 추가
  - splice 수정
  - 1차 배치 상위 2개 그룹 제한

- `js/main-unified.js`
  - 배치 실패 시 결과 표시 유지
  - 잔여 표시 기준 완화 (50mm)
  - materialUsageRate null guard

- `js/renderer.js`
  - 잔여 표시 기준 완화 (50mm)

- `index.html`
  - `materialUsageRate` 표시 추가

---

*Last Updated: 2026-02-04*
