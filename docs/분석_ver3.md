# 대장간 V4 - 종합 개발 계획서 Ver.3 (정리본)

> 작성일: 2026-02-04  \
> 버전: 3.1 (현행 코드 기준 정합성 반영)  \
> 작성자: 시니어 풀스택 엔지니어 (20년 경력)

---

## 1. 문서 목적

현행 코드 상태와 일치하는 기준으로 **버그 수정 / 알고리즘 개선 / 검증 계획**을 정리한다.  
숫자/효과는 **전제 조건(판재 크기, kerf, 회전/나무결)**을 명시한 경우에만 확정한다.

---

## 2. 전제 조건 (반드시 명시)

- 판재 크기: `width × height`
- kerf 값: mm
- 회전 허용 여부 (`rotatable` + 나무결)
- 모드: `horizontal` / `auto`

> **중요**: 위 전제가 없으면 "n장" 같은 수치 목표는 *추정치*로만 기록한다.

---

## 3. 현재 코드 상태 요약 (2026-02-04 기준)

### 3.1 적용 완료
- **splice 버그 수정**: `StripBin`, `StripEfficiencyBin`에서 인덱스 제거 순서 수정
- **auto 모드 교체**: `rip-reapply` (2단계 리핑-재적용)로 변경
- **horizontal 모드 변경**: 동일 폭 스트립 배치(`WidthStripBin`)
- **재단비 미노출 방어**: `materialUsageRate` DOM null guard
- **UI 보강**: `index.html`에 `materialUsageRate` 표시 추가

### 3.2 아직 미적용
- PDF 여유 공간 표시 로직 정리
- `index-mobile.html`의 재단비/사용률 표시 보강
- 계산 실패(배치 불가) 시 UI 갱신 처리

---

## 4. 알고리즘 설계 (현행 기준)

### 4.1 Auto: 2단계 리핑-재적용

1. **1차 배치**: 판재 전체에 리핑(스트립) 배치
2. **잔여 직사각형 추출**
3. **2차 배치**: 잔여를 "새 판재"로 간주하고 동일 리핑 로직 적용
4. **추가 배치가 없으면 종료**

### 4.2 리핑 방향 규칙
- 각 직사각형에서 **짧은 축 기준으로 리핑 방향 자동 선택**
  - `rect.width <= rect.height` → 폭 스트립 기준
  - 그 외 → 높이 스트립 기준

### 4.3 회전 규칙
- **해당 잔여 직사각형에서만** 회전을 시도
- 원본 아이템은 변경하지 않고, 배치용 복사본만 회전

### 4.4 선택 기준
- auto는 `rip-reapply` 결과를 그대로 사용
- horizontal은 **동일 폭 스트립 내 배치만 허용**

---

## 5. 리스크 / 트레이드오프

1. **절단 난이도 상승 가능**
   - 리핑-재적용은 절단선 수가 증가할 수 있음
2. **회전 규칙에 따른 결과 변동**
   - 잔여 직사각형마다 회전 판단 → 결과 패턴이 고정되지 않음
3. **폭 빈도 우선의 한계**
   - 큰 폭 그룹이 먼저 배치되면 작은 폭 그룹이 배치 기회를 잃을 수 있음

---

## 6. 테스트 전략 (로컬 실행 기반)

### 6.1 로컬 실행 스크립트
- `Test/run_packer.js`
- 기본 3개 시나리오 포함

```bash
node Test/run_packer.js
node Test/run_packer.js Test/scenario.json
```

### 6.2 고정 테스트 케이스 (전제 포함)
> 아래 값은 **전제 명시 후** 확정 결과를 기록한다.

- 400×300 35개 (horizontal)
- 400×300 35개 (auto)
- 1000×800×9, 910×650×9, 530×450×9 (auto)

---

## 7. 남은 작업 (우선순위)

1. **재단비 미노출 완전 해결**
   - `index-mobile.html`에도 결과 영역 추가
   - 배치 불가 시에도 결과 UI 갱신

2. **PDF 출력 개선**
   - 잔여 영역 표시 기준 분리
   - 하단 잔여 강제 생성

3. **성능/품질 검증**
   - 케이스별 결과 기록 및 회귀 테스트 추가

---

## 8. 변경 로그

- Ver.3.1: 현행 코드 상태 반영, 수치/가정 분리, 리스크/테스트 추가

---

*Last Updated: 2026-02-04*
