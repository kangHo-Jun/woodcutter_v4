# 대장간 V3 - 재단 최적화 알고리즘 (Algorithm Documentation)

대장간 V3는 **Guillotine Bin Packing** 알고리즘을 변형하여 목재 재단의 특성(기계적 절단 편의성, 톱날 두께 손실)을 최적화한 엔진을 사용합니다.

---

## 1. 최적화 엔진: GuillotinePacker

메인 엔진은 두 가지 전략을 실행하고 상황에 맞는 최적의 결과를 선택합니다.

### A. 가로 우선 모드 (Horizontal / Strip-based)
*   **철학**: "최소한의 칼질(절단)로 가장 빠르게 재단"
*   **로직**: 
    1.  부품을 높이 기준으로 내림차순 정렬합니다.
    2.  정확히 동일한 높이의 부품들을 하나의 '스트립(Strip)'으로 묶습니다.
    3.  판재의 남은 높이가 스트립 높이보다 크면 스트립을 배치합니다.
    4.  각 스트립 내부에서는 너비 방향으로만 부품을 채웁니다.
*   **장점**: 모든 절단선이 판재를 가로지르는 직선이므로 테이블쏘 작업에 가장 적합합니다.

### B. 스트립 효율 모드 (Strip Efficiency)
*   **철학**: "절단 편의성을 유지하면서도 버려지는 자투리 공간을 최소화"
*   **로직 (5단계 프로세스)**:
    1.  **높이 그룹화**: 정확한 높이가 아니더라도 **10% 오차 범위** 내의 부품들을 같은 그룹으로 묶어 배치 가능성을 높입니다.
    2.  **기본 스트립 배치**: 그룹화된 부품들을 높이 내림차순으로 스트립화하여 배치합니다.
    3.  **스트립 우측 활용**: 스트립 끝에 남은 공간(Free Rect)에 맞는 작은 부품이 있다면 회전 없이 추가 배치합니다.
    4.  **세밀한 공간 분할**: 우측 활용 시 남은 자투리 공간을 다시 수평/수직으로 분할하여 더 작은 부품 배치를 시도합니다.
    5.  **하단 잔여 공간 활용**: 모든 스트립 배치가 끝난 후 판재 최하단에 남은 거대한 자투리 공간에 unplaced 부품들을 추가로 채워 넣습니다.

### C. 자동 선택 모드 (Auto Choice)
`auto` 모드에서는 위 두 알고리즘을 모두 실행한 후 다음 기준으로 선택합니다.
*   **제1원칙**: 사용되는 **판재 장수(`bins.length`)**가 적은 쪽을 선택합니다.
*   **제2원칙**: 장수가 같다면 절단이 더 편리한 **가로 우선 모드**를 우선 선택합니다.

---

## 2. 핵심 기술 상세

### 높이 정규화 (Normalization)
회전 가능한 부품(`rotatable: true`)의 경우, 스트립 배치의 효율을 극대화하기 위해 항상 **높이가 너비보다 작거나 같도록(Long Edge Horizontal)** 회전시켜 눕힌 상태로 배치를 시작합니다. 이는 스트립의 개수를 줄이고 한 줄에 더 많은 부품을 넣기 위함입니다.

### 톱날 두께 (Kerf) 처리
모든 배치 계산 시 사용자가 설정한 `kerf` 값이 반영됩니다.
*   부품 사이의 간격뿐만 아니라, 판재 테두리(트리밍/전단여부)와의 간격도 정밀하게 계산합니다.
*   `neededWidth = x === 0 ? width : width + kerf` 로직을 통해 첫 부품 이후부터 손실 면적을 계산에 포함합니다.

### 치수 및 라벨링 엔진
재단 도면의 가독성을 위해 `LabelingEngine`이 별도로 작동합니다.
*   동일 규격 부품은 동일한 라벨(A, B, C...)을 부여받습니다.
*   도면 혼잡을 막기 위해 동일 라벨의 **첫 번째 부품**에만 상세 수치(`W x H`)를 표시합니다.

---

## 3. 알고리즘 제약 및 향후 과제

1.  **Nested Packing 미지원**: 현재는 기계적 절단을 위해 2단계(Level) 이상의 복잡한 중첩 배치는 지양하고 있습니다. (Guillotine Cut 보장)
2.  **나무결(Grain) 제약**: 나무결 고정 시 회전 알고리즘이 자동으로 비활성화되어 물리적 특성을 준수합니다.

---
*Last Updated: 2026-01-30*
