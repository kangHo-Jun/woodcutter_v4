# 대장간 V4 - 버그 분석 보고서 Ver.2

> 분석일: 2026-02-04  
> 버전: 2.0 (splice 수정안 논리 오류 수정)

(기존 내용 동일, 하단에 섹션 8 추가)

---

## 8. PDF 출력 시 여유 공간 미표시 이슈 (2440 × 178.5 × 6)

### 8.1 이슈 개요

다음 조건에서 PDF 출력 결과에 판재 하단 여유 공간이 표시되지 않는 문제가 확인되었다.

- 판재 길이: **2440**
- 스트립 높이: **178.5**
- 스트립 개수: **6개**

계산상 사용 높이와 잔여 공간은 다음과 같다.

```
사용 높이 = 178.5 × 6 = 1071
잔여 높이 = 2440 − 1071 = 1369
```

잔여 공간은 **50 이상(1369)**임에도 불구하고, PDF 출력에서는 해당 영역이 시각적으로 표시되지 않는다.

---

### 8.2 원인 분석

본 이슈는 배치 알고리즘(pack logic)의 문제가 아니라 **PDF 시각화(rendering) 단계의 조건 필터링 문제**이다.

#### 원인 A: 여유 공간을 배치 가능 공간 기준으로 필터링

PDF 출력 단계에서 freeRect(잔여 영역)를 다음과 같은 기준으로 제한하고 있는 경우, 실제 여유 공간이 있음에도 출력되지 않는다.

- 최소 부품 크기(`minPartHeight`, `minPartWidth`) 이상일 때만 출력
- `canFitAnyPart`, `isUsable` 등 배치 가능 여부 플래그가 true인 경우만 출력

이로 인해 **작업자 참고용 여유 공간**이 배치 불가 영역이라는 이유로 제거된다.

#### 원인 B: 마지막 스트립 하단 잔여 영역 미생성

모든 스트립 배치 완료 후 판재 하단에 남는 직사각형 영역을 freeRect로 명시적으로 생성하지 않는 구조일 경우, 해당 여유 공간은 렌더링 단계로 전달되지 않는다.

---

### 8.3 문제의 본질

여유 공간은 추가 배치를 위한 알고리즘 데이터가 아니라, **작업자가 절단 후 남는 자투리를 직관적으로 확인하기 위한 시각 정보**이다.

현재 구현은 배치 기준과 시각화 기준을 혼용하고 있어, 배치 불가 영역을 PDF에서도 제거하는 문제가 발생한다.

---

### 8.4 수정 방안

#### 8.4.1 여유 공간 표시 기준 분리

PDF 출력용 여유 공간은 다음 단일 기준만 적용한다.

```
여유 높이 ≥ 50 이면 무조건 출력
(배치 가능 여부와 무관)
```

#### 8.4.2 마지막 스트립 하단 여유 영역 강제 생성

모든 스트립 배치 후 다음 로직을 적용한다.

```
usedHeight = Σ strip.height
remainingHeight = panelHeight − usedHeight
```

- `remainingHeight ≥ 50` 인 경우
- 해당 영역을 freeRect로 생성하여 PDF 렌더링 대상에 포함한다.

#### 8.4.3 PDF 렌더링 단계 필터 정리

PDF 출력 단계에서는 다음 조건을 **사용하지 않는다**.

- `canFitPart`
- `isUsable`
- `minPartSize`

여유 공간 출력 조건은 오직 다음 하나만 사용한다.

```
freeRect.height ≥ 50
```

---

### 8.5 기대 효과

| 항목 | 변경 전 | 변경 후 |
|---|---|---|
| 2440 × 178.5 × 6 케이스 | 여유 공간 미표시 | 여유 공간 명확히 표시 |
| 작업자 PDF 가독성 | 잔여 판단 불가 | 절단 후 잔여 직관적 확인 |
| 배치 알고리즘 영향 | 없음 | 없음 |

---

### 8.6 결론

본 이슈는 알고리즘 버그가 아닌 **PDF 출력 규칙 누락 문제**이며, 여유 공간 표시 기준을 배치 로직과 분리함으로써 해결된다.

